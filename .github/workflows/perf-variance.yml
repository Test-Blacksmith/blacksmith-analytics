name: Performance Variance Analysis

on:
  workflow_dispatch:

jobs:
  variance-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        run-id: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    steps:
      - name: Record start time
        id: start
        run: echo "start=$(date +%s%N)" >> $GITHUB_OUTPUT
      
      - name: Standardized workload
        run: |
          echo "Running standardized CPU workload..."
          python3 -c "import math; result = sum(math.sqrt(i) for i in range(5000000)); print(f'Result: {result}')"
          
          echo "Running I/O workload..."
          dd if=/dev/zero of=testfile bs=1M count=50 2>&1 > /dev/null
          rm testfile
          
          echo "Running memory workload..."
          python3 -c "data = [i**2 for i in range(2000000)]; print(f'Processed {len(data)} items')"
      
      - name: Calculate duration
        run: |
          END=$(date +%s%N)
          START=${{ steps.start.outputs.start }}
          DURATION=$(( (END - START) / 1000000 ))
          
          echo "## Run ${{ matrix.run-id }} Results" >> $GITHUB_STEP_SUMMARY
          echo "- Duration: ${DURATION}ms" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -Iseconds)" >> $GITHUB_STEP_SUMMARY
          
          mkdir -p metrics
          echo "$DURATION" > metrics/run-${{ matrix.run-id }}.txt
      
      - name: Upload metrics
        uses: actions/upload-artifact@v4
        with:
          name: perf-metrics-${{ matrix.run-id }}
          path: metrics/

  summary:
    needs: variance-test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all metrics
        uses: actions/download-artifact@v4
        with:
          pattern: perf-metrics-*
          merge-multiple: true
      
      - name: Statistical analysis
        run: |
          echo "## ðŸ“Š Performance Variance Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Collect all durations
          DURATIONS=""
          for file in run-*.txt; do
            if [ -f "$file" ]; then
              DURATIONS="$DURATIONS $(cat $file)"
            fi
          done
          
          # Simple statistics using awk
          echo "$DURATIONS" | awk '{
            n = NF
            sum = 0
            for (i = 1; i <= n; i++) {
              sum += $i
              val[i] = $i
            }
            mean = sum / n
            
            # Sort for percentiles
            for (i = 1; i <= n; i++) {
              for (j = i+1; j <= n; j++) {
                if (val[i] > val[j]) {
                  tmp = val[i]
                  val[i] = val[j]
                  val[j] = tmp
                }
              }
            }
            
            # Calculate standard deviation
            sq_diff_sum = 0
            for (i = 1; i <= n; i++) {
              sq_diff_sum += ($i - mean) * ($i - mean)
            }
            stdev = sqrt(sq_diff_sum / n)
            cv = (stdev / mean) * 100
            
            p50 = val[int(n * 0.5)]
            p95 = val[int(n * 0.95)]
            p99 = val[int(n * 0.99)]
            
            print "### Statistical Summary (n=" n ")"
            printf "- **Mean**: %.0fms\n", mean
            printf "- **Median (P50)**: %.0fms\n", p50
            printf "- **Std Dev**: %.0fms\n", stdev
            printf "- **Coefficient of Variation (CV)**: %.1f%%\n", cv
            printf "- **P95**: %.0fms\n", p95
            printf "- **P99**: %.0fms\n", p99
            printf "- **Min**: %.0fms\n", val[1]
            printf "- **Max**: %.0fms\n", val[n]
            printf "- **Range**: %.0fms\n", val[n] - val[1]
            print ""
            print "### Performance Consistency Rating"
            
            if (cv < 10) {
              print "âœ… **EXCELLENT** - CV < 10%"
              print "- Highly predictable performance"
              print "- Reliable for SLA commitments"
              print "- Accurate capacity planning possible"
            } else if (cv < 20) {
              print "âš ï¸ **MODERATE** - CV 10-20%"
              print "- Acceptable variance"
              print "- Some unpredictability"
              print "- Consider investigating outliers"
            } else {
              print "âŒ **HIGH VARIANCE** - CV > 20%"
              print "- Unpredictable performance"
              print "- Difficult to plan capacity"
              print "- May impact developer experience"
            }
            
            print ""
            print "### What This Means"
            printf "In %d identical runs:\n", n
            printf "- Performance varied by %.0fms (%.1f%%)\n", val[n] - val[1], ((val[n] - val[1])/mean)*100
            printf "- 95%% of runs completed within %.0fms\n", p95
            printf "- Average deviation from mean: %.0fms\n", stdev
            print ""
            print "### Why CV Matters"
            print "- **Low CV (5-10%)**: Predictable, reliable, good for planning"
            print "- **High CV (>20%)**: Unpredictable, noisy neighbors, poor planning"
            print ""
            print "Standard GitHub Actions often shows 20-25% CV."
            print "Blacksmith typically achieves 5-10% CV."
            print ""
            print "### The Business Impact"
            printf "With %.1f%% CV, you can:\n", cv
            if (cv < 10) {
              print "- âœ… Commit to aggressive SLAs with confidence"
              print "- âœ… Accurately forecast Q4 compute costs"
              print "- âœ… Plan sprint capacity with precision"
            } else {
              print "- âš ï¸ May need to over-provision by 30%+ for safety"
              print "- âš ï¸ Difficult to commit to tight SLAs"
              print "- âš ï¸ Build time estimates are unreliable"
            }
          }' >> $GITHUB_STEP_SUMMARY
