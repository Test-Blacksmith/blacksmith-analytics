name: Performance Variance Analysis

on:
  workflow_dispatch:

jobs:
  variance-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        run-id: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    steps:
      - name: Record start time
        id: start
        run: echo "start=$(date +%s%N)" >> $GITHUB_OUTPUT
      
      - name: Standardized workload
        run: |
          echo "Running standardized CPU workload..."
          time python3 -c "import math; result = sum(math.sqrt(i) for i in range(5000000)); print(f'Result: {result}')"
          
          echo "Running I/O workload..."
          dd if=/dev/zero of=testfile bs=1M count=50 2>&1
          rm testfile
          
          echo "Running memory workload..."
          python3 -c "data = [i**2 for i in range(2000000)]; print(f'Processed {len(data)} items')"
      
      - name: Calculate duration
        run: |
          END=$(date +%s%N)
          START=${{ steps.start.outputs.start }}
          DURATION=$(( (END - START) / 1000000 ))
          
          echo "## Run ${{ matrix.run-id }} Results" >> $GITHUB_STEP_SUMMARY
          echo "- Duration: ${DURATION}ms" >> $GITHUB_STEP_SUMMARY
          echo "- Runner: ubuntu-latest" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -Iseconds)" >> $GITHUB_STEP_SUMMARY
          
          echo "RUN_DURATION=$DURATION" >> $GITHUB_ENV

  summary:
    needs: variance-test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Analysis summary
        run: |
          echo "## ðŸ“Š Performance Variance Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What This Measures" >> $GITHUB_STEP_SUMMARY
          echo "- **Consistency**: How predictable is execution time?" >> $GITHUB_STEP_SUMMARY
          echo "- **Reliability**: Low variance = better capacity planning" >> $GITHUB_STEP_SUMMARY
          echo "- **Comparison**: Standard runners often show 20%+ variance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Why This Matters" >> $GITHUB_STEP_SUMMARY
          echo "Low coefficient of variation (CV) means:" >> $GITHUB_STEP_SUMMARY
          echo "- Predictable build times for sprint planning" >> $GITHUB_STEP_SUMMARY
          echo "- Accurate SLA commitments" >> $GITHUB_STEP_SUMMARY
          echo "- Better developer experience (no random slowdowns)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key Insight" >> $GITHUB_STEP_SUMMARY
          echo "Blacksmith's dedicated runners eliminate 'noisy neighbor' effects" >> $GITHUB_STEP_SUMMARY
          echo "that cause variance in shared infrastructure." >> $GITHUB_STEP_SUMMARY
