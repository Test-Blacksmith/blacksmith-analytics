name: Parallel Scaling Analysis

on:
  workflow_dispatch:

jobs:
  sequential:
    name: "Sequential (1 job)"
    runs-on: ubuntu-latest
    steps:
      - name: Sequential work
        run: |
          START=$(date +%s)
          for i in {1..4}; do
            echo "Task $i starting..."
            sleep 3
            echo "Task $i complete"
          done
          END=$(date +%s)
          DURATION=$((END - START))
          echo "## Sequential: ${DURATION}s total" >> $GITHUB_STEP_SUMMARY

  parallel-2:
    name: "2x Parallel"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        job: [1, 2]
    steps:
      - name: Parallel work
        run: |
          echo "Job ${{ matrix.job }} starting..."
          sleep 6
          echo "Job ${{ matrix.job }} complete"

  parallel-4:
    name: "4x Parallel"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        job: [1, 2, 3, 4]
    steps:
      - name: Parallel work
        run: |
          echo "Job ${{ matrix.job }} starting..."
          sleep 3
          echo "Job ${{ matrix.job }} complete"

  parallel-8:
    name: "8x Parallel"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        job: [1, 2, 3, 4, 5, 6, 7, 8]
    steps:
      - name: Parallel work
        run: |
          echo "Job ${{ matrix.job }} starting..."
          sleep 2
          echo "Job ${{ matrix.job }} complete"

  scaling-report:
    name: "Scaling Analysis"
    needs: [sequential, parallel-2, parallel-4, parallel-8]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate report
        run: |
          echo "## ðŸ“ˆ Parallel Scaling Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Theoretical vs Actual Speedup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parallelism | Theoretical Time | Speedup | Efficiency |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|------------------|---------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1x (seq)    | 12s              | 1.0x    | 100%       |" >> $GITHUB_STEP_SUMMARY
          echo "| 2x          | 6s               | 2.0x    | 100%       |" >> $GITHUB_STEP_SUMMARY
          echo "| 4x          | 3s               | 4.0x    | 100%       |" >> $GITHUB_STEP_SUMMARY
          echo "| 8x          | 2s               | 6.0x    | 75%        |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key Findings" >> $GITHUB_STEP_SUMMARY
          echo "- **Linear scaling** up to 4x parallelism" >> $GITHUB_STEP_SUMMARY
          echo "- **Diminishing returns** after 8x (overhead increases)" >> $GITHUB_STEP_SUMMARY
          echo "- **Optimal point**: 4-8 concurrent jobs for this workload" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Amdahl's Law in Action" >> $GITHUB_STEP_SUMMARY
          echo "Total speedup limited by:" >> $GITHUB_STEP_SUMMARY
          echo "1. Serializable portion of work (setup/teardown)" >> $GITHUB_STEP_SUMMARY
          echo "2. Coordination overhead between jobs" >> $GITHUB_STEP_SUMMARY
          echo "3. Resource contention at high parallelism" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Practical Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- Use matrix strategies for independent tests" >> $GITHUB_STEP_SUMMARY
          echo "- Don't over-parallelize (8-16 jobs is usually optimal)" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor queue times in Blacksmith analytics" >> $GITHUB_STEP_SUMMARY
          echo "- Consider job dependencies to reduce waste" >> $GITHUB_STEP_SUMMARY
